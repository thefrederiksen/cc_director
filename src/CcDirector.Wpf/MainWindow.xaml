<Window x:Class="CcDirector.Wpf.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:CcDirector.Wpf.Controls"
        Title="CC Director v2"
        Icon="app.ico"
        Width="1400" Height="700"
        MinWidth="800" MinHeight="500"
        Background="{StaticResource PanelBackground}"
        WindowStartupLocation="CenterScreen">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="264" MinWidth="180" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition x:Name="PipeMessagesColumn" Width="0" />
        </Grid.ColumnDefinitions>

            <!-- Left sidebar: sessions panel (full height) -->
            <Border Grid.Column="0" Background="{StaticResource SidebarBackground}">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top"
                               Text="SESSIONS"
                               Foreground="{StaticResource TextForeground}"
                               FontWeight="SemiBold"
                               FontSize="12"
                               Margin="12,12,12,8" />

                    <StackPanel DockPanel.Dock="Bottom" Margin="8,4,8,8">
                        <Button x:Name="BtnNewSession" Content="+ New Session"
                                Click="BtnNewSession_Click"
                                Focusable="False"
                                Height="30" Margin="0,2"
                                Background="{StaticResource AccentBrush}"
                                Foreground="White"
                                BorderThickness="0"
                                Cursor="Hand" />
                        <Button x:Name="BtnOpenLogs" Content="Open Logs"
                                Click="BtnOpenLogs_Click"
                                Focusable="False"
                                Height="30" Margin="0,2"
                                Background="{StaticResource ButtonBackground}"
                                Foreground="{StaticResource TextForeground}"
                                BorderThickness="0"
                                Cursor="Hand"
                                ToolTip="Open log directory in Explorer" />
                        <Button x:Name="BtnOpenSessions" Content="Open Sessions"
                                Click="BtnOpenSessions_Click"
                                Focusable="False"
                                Height="30" Margin="0,2"
                                Background="{StaticResource ButtonBackground}"
                                Foreground="{StaticResource TextForeground}"
                                BorderThickness="0"
                                Cursor="Hand"
                                ToolTip="Open sessions.json in default editor" />
                        <Button x:Name="BtnOpenHistory" Content="Open History"
                                Click="BtnOpenHistory_Click"
                                Focusable="False"
                                Height="30" Margin="0,2"
                                Background="{StaticResource ButtonBackground}"
                                Foreground="{StaticResource TextForeground}"
                                BorderThickness="0"
                                Cursor="Hand"
                                ToolTip="Open session history folder in Explorer" />
                        <Button x:Name="BtnOpenHistoryVsCode" Content="History in VS Code"
                                Click="BtnOpenHistoryVsCode_Click"
                                Focusable="False"
                                Height="30" Margin="0,2"
                                Background="{StaticResource ButtonBackground}"
                                Foreground="{StaticResource TextForeground}"
                                BorderThickness="0"
                                Cursor="Hand"
                                ToolTip="Open session history folder in VS Code" />
                        <TextBlock x:Name="BuildInfoText"
                                   Text="Build: ---"
                                   Foreground="#555555"
                                   FontSize="9"
                                   HorizontalAlignment="Center"
                                   Margin="0,4,0,0" />
                    </StackPanel>

                    <ListBox x:Name="SessionList"
                             SelectionChanged="SessionList_SelectionChanged"
                             IsTabStop="False"
                             KeyboardNavigation.TabNavigation="None"
                             PreviewKeyDown="SessionList_PreviewKeyDown"
                             AllowDrop="True"
                             PreviewMouseMove="SessionList_PreviewMouseMove"
                             PreviewMouseLeftButtonDown="SessionList_PreviewMouseLeftButtonDown"
                             DragOver="SessionList_DragOver"
                             Drop="SessionList_Drop"
                             DragLeave="SessionList_DragLeave"
                             Background="Transparent"
                             BorderThickness="0"
                             Foreground="{StaticResource TextForeground}"
                             Margin="4,0">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="IsTabStop" Value="False" />
                                <Setter Property="Padding" Value="0" />
                                <Setter Property="Margin" Value="0" />
                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Grid.ContextMenu>
                                        <ContextMenu Opened="SessionContextMenu_Opened" Closed="SessionContextMenu_Closed">
                                            <MenuItem Header="Rename" Click="MenuRenameSession_Click" />
                                            <Separator />
                                            <MenuItem Header="Open in Explorer" Click="MenuOpenInExplorer_Click" />
                                            <MenuItem Header="Open in VS Code" Click="MenuOpenInVsCode_Click" />
                                            <MenuItem Header="GitHub Issues" Click="MenuGitHubIssues_Click" />
                                            <Separator />
                                            <MenuItem Header="Close Session" Click="MenuCloseSession_Click" />
                                        </ContextMenu>
                                    </Grid.ContextMenu>
                                    <Border BorderBrush="{Binding ActivityBrush}"
                                            BorderThickness="4,0,0,0"
                                            Padding="6,4,4,4">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>

                                            <!-- Row 0: Display name + Status text -->
                                            <StackPanel Grid.Row="0">
                                                <!-- Session name -->
                                                <TextBlock Text="{Binding DisplayName}"
                                                           FontWeight="Medium"
                                                           FontSize="13"
                                                           TextTrimming="CharacterEllipsis" />
                                                <!-- Status: Working (PID xxx) - ConPTY -->
                                                <TextBlock Text="{Binding StatusText}"
                                                           FontSize="10"
                                                           Foreground="#888888"
                                                           Margin="0,1,0,0" />
                                            </StackPanel>

                                            <!-- Row 1: ClaudeSessionId + Verification badge + [Open] [Relink] buttons -->
                                            <DockPanel Grid.Row="1" Margin="0,4,0,0">
                                                <!-- Buttons (right-aligned) -->
                                                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Margin="6,0,0,0">
                                                    <!-- Open .jsonl button -->
                                                    <Button Content="Open"
                                                            Click="SessionOpenJsonl_Click"
                                                            Focusable="False"
                                                            FontSize="9"
                                                            Padding="6,2"
                                                            Margin="0,0,4,0"
                                                            Background="#374151"
                                                            Foreground="#D1D5DB"
                                                            BorderThickness="0"
                                                            Cursor="Hand"
                                                            ToolTip="Open .jsonl file in Explorer">
                                                        <Button.Style>
                                                            <Style TargetType="Button">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                                <Setter Property="IsEnabled" Value="True" />
                                                                <Style.Triggers>
                                                                    <!-- Hide when waiting for terminal verification -->
                                                                    <DataTrigger Binding="{Binding IsTerminalVerificationWaiting}" Value="True">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                    <!-- Hide when terminal verification failed -->
                                                                    <DataTrigger Binding="{Binding IsTerminalVerificationFailed}" Value="True">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                    <!-- Disable when file not found or error -->
                                                                    <DataTrigger Binding="{Binding Session.VerificationStatus}" Value="FileNotFound">
                                                                        <Setter Property="IsEnabled" Value="False" />
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding Session.VerificationStatus}" Value="Error">
                                                                        <Setter Property="IsEnabled" Value="False" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                    </Button>
                                                    <!-- Relink button -->
                                                    <Button Content="Relink"
                                                            Click="SessionRelink_Click"
                                                            Focusable="False"
                                                            FontSize="9"
                                                            Padding="6,2"
                                                            Background="#374151"
                                                            Foreground="#D1D5DB"
                                                            BorderThickness="0"
                                                            Cursor="Hand"
                                                            ToolTip="Re-link to a different Claude session">
                                                        <Button.Style>
                                                            <Style TargetType="Button">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                                <Style.Triggers>
                                                                    <!-- Hide when waiting for terminal verification -->
                                                                    <DataTrigger Binding="{Binding IsTerminalVerificationWaiting}" Value="True">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                    </Button>
                                                </StackPanel>
                                                <!-- Terminal Verification badge -->
                                                <Border CornerRadius="2"
                                                        Padding="4,1"
                                                        Margin="0,0,4,0"
                                                        VerticalAlignment="Center"
                                                        ToolTip="{Binding TerminalVerificationStatusText}">
                                                    <Border.Style>
                                                        <Style TargetType="Border">
                                                            <Setter Property="Background" Value="#22C55E" />
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                            <Style.Triggers>
                                                                <!-- Gray for waiting -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationWaiting}" Value="True">
                                                                    <Setter Property="Visibility" Value="Visible" />
                                                                    <Setter Property="Background" Value="#6B7280" />
                                                                </DataTrigger>
                                                                <!-- Yellow/Orange for potential match -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationPotential}" Value="True">
                                                                    <Setter Property="Visibility" Value="Visible" />
                                                                    <Setter Property="Background" Value="#F59E0B" />
                                                                </DataTrigger>
                                                                <!-- Green for confirmed match -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationMatched}" Value="True">
                                                                    <Setter Property="Visibility" Value="Visible" />
                                                                    <Setter Property="Background" Value="#22C55E" />
                                                                </DataTrigger>
                                                                <!-- Red for failed -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationFailed}" Value="True">
                                                                    <Setter Property="Visibility" Value="Visible" />
                                                                    <Setter Property="Background" Value="#EF4444" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <TextBlock FontSize="8" FontWeight="Bold" Foreground="White">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Text" Value="OK" />
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsTerminalVerificationWaiting}" Value="True">
                                                                        <Setter Property="Text" Value="?" />
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding IsTerminalVerificationPotential}" Value="True">
                                                                        <Setter Property="Text" Value="?" />
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding IsTerminalVerificationFailed}" Value="True">
                                                                        <Setter Property="Text" Value="!" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Border>
                                                <!-- Claude session ID or status text -->
                                                <TextBlock FontFamily="Consolas, Courier New"
                                                           FontSize="10"
                                                           VerticalAlignment="Center">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Text" Value="{Binding ClaudeSessionIdShort}" />
                                                            <Setter Property="Foreground" Value="#9CA3AF" />
                                                            <Style.Triggers>
                                                                <!-- Show "Waiting..." when waiting -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationWaiting}" Value="True">
                                                                    <Setter Property="Text" Value="Waiting..." />
                                                                    <Setter Property="Foreground" Value="#6B7280" />
                                                                </DataTrigger>
                                                                <!-- Show session ID in yellow/orange when potential match -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationPotential}" Value="True">
                                                                    <Setter Property="Foreground" Value="#F59E0B" />
                                                                </DataTrigger>
                                                                <!-- Show "Verification Failed" in red when failed -->
                                                                <DataTrigger Binding="{Binding IsTerminalVerificationFailed}" Value="True">
                                                                    <Setter Property="Text" Value="Verification Failed" />
                                                                    <Setter Property="Foreground" Value="#EF4444" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </DockPanel>

                                            <!-- Row 2: Stats badges + three-dot menu -->
                                            <DockPanel Grid.Row="2" Margin="0,4,0,0">
                                                <!-- Three-dot menu button (right-aligned) -->
                                                <Button DockPanel.Dock="Right"
                                                        Content="..."
                                                        Click="SessionMenuButton_Click"
                                                        Focusable="False"
                                                        VerticalAlignment="Center"
                                                        Padding="6,2"
                                                        Margin="4,0,0,0"
                                                        MinWidth="24"
                                                        Background="Transparent"
                                                        Foreground="#888888"
                                                        BorderThickness="0"
                                                        Cursor="Hand"
                                                        FontWeight="Bold"
                                                        FontSize="12"
                                                        ToolTip="Session options">
                                                    <Button.Style>
                                                        <Style TargetType="Button">
                                                            <Setter Property="Opacity" Value="0.5" />
                                                            <Style.Triggers>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter Property="Opacity" Value="1" />
                                                                    <Setter Property="Foreground" Value="#CCCCCC" />
                                                                </Trigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                </Button>
                                                <!-- Stats badges -->
                                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                    <!-- Message count badge -->
                                                    <Border Background="#3B82F6"
                                                            CornerRadius="8"
                                                            Padding="6,2"
                                                            Margin="0,0,6,0"
                                                            VerticalAlignment="Center">
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding HasClaudeMetadata}" Value="False">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding ClaudeMessageCount}"
                                                                       Foreground="White"
                                                                       FontSize="9"
                                                                       FontWeight="SemiBold" />
                                                            <TextBlock Text=" msgs"
                                                                       Foreground="White"
                                                                       FontSize="9"
                                                                       Opacity="0.8" />
                                                        </StackPanel>
                                                    </Border>
                                                    <!-- Uncommitted changes badge (orange) -->
                                                    <Border Background="#D97706"
                                                            CornerRadius="8"
                                                            Padding="6,2"
                                                            VerticalAlignment="Center">
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding HasUncommittedChanges}" Value="False">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding UncommittedCount}"
                                                                       Foreground="White"
                                                                       FontSize="9"
                                                                       FontWeight="SemiBold" />
                                                            <TextBlock Text=" uncommitted"
                                                                       Foreground="White"
                                                                       FontSize="9"
                                                                       Opacity="0.8" />
                                                        </StackPanel>
                                                    </Border>
                                                </StackPanel>
                                            </DockPanel>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>

            <!-- Splitter (left) -->
            <GridSplitter Grid.Column="1" Width="3"
                          Focusable="False"
                          Background="{StaticResource PanelBackground}"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Stretch" />

            <!-- Center: header + terminal + prompt stacked vertically -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Session header banner -->
                <Border x:Name="SessionHeaderBanner" Grid.Row="0"
                        Background="#252526"
                        BorderBrush="#3C3C3C" BorderThickness="0,0,0,1"
                        MinHeight="48"
                        Visibility="Collapsed">
                    <Grid Margin="16,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <!-- Session name -->
                        <TextBlock x:Name="HeaderSessionName" Grid.Column="0" Grid.Row="0"
                                   Text=""
                                   Foreground="White"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"
                                   TextTrimming="CharacterEllipsis" />

                        <!-- Activity state badge + message count -->
                        <StackPanel Grid.Column="1" Grid.Row="0" Grid.RowSpan="2"
                                    Orientation="Horizontal"
                                    VerticalAlignment="Center">
                            <!-- Message count badge -->
                            <Border x:Name="HeaderMessageCountBadge"
                                    Background="#3B82F6"
                                    CornerRadius="4"
                                    Padding="8,4"
                                    Margin="0,0,8,0"
                                    VerticalAlignment="Center"
                                    Visibility="Collapsed">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock x:Name="HeaderMessageCountText"
                                               Text="0"
                                               Foreground="White"
                                               FontSize="12"
                                               FontWeight="SemiBold" />
                                    <TextBlock Text=" msgs"
                                               Foreground="White"
                                               FontSize="12"
                                               Opacity="0.8" />
                                </StackPanel>
                            </Border>

                            <!-- Activity state badge -->
                            <Border x:Name="HeaderStateBadge"
                                    CornerRadius="4"
                                    Padding="10,4"
                                    VerticalAlignment="Center"
                                    Background="#336B7280">
                                <TextBlock x:Name="HeaderStateBadgeText"
                                           Text="Starting"
                                           Foreground="White"
                                           FontSize="12"
                                           FontWeight="SemiBold" />
                            </Border>
                        </StackPanel>

                        <!-- Claude summary text -->
                        <TextBlock x:Name="HeaderClaudeSummary" Grid.Column="0" Grid.Row="1"
                                   Text=""
                                   Foreground="#9CA3AF"
                                   FontSize="11"
                                   TextTrimming="CharacterEllipsis"
                                   Margin="0,2,16,0"
                                   Visibility="Collapsed" />

                        <!-- Session ID and verification row -->
                        <StackPanel x:Name="HeaderSessionIdPanel" Grid.Column="0" Grid.Row="2"
                                    Orientation="Horizontal"
                                    Margin="0,4,0,0"
                                    Visibility="Collapsed">
                            <TextBlock Text="Claude ID: "
                                       Foreground="#6B7280"
                                       FontSize="10" />
                            <TextBlock x:Name="HeaderSessionId"
                                       Text="Not linked"
                                       Foreground="#9CA3AF"
                                       FontSize="10"
                                       FontFamily="Consolas, Courier New" />
                            <!-- Verification badge -->
                            <Border x:Name="HeaderVerificationBadge"
                                    CornerRadius="2"
                                    Padding="4,1"
                                    Margin="8,0,0,0"
                                    VerticalAlignment="Center">
                                <TextBlock x:Name="HeaderVerificationText"
                                           Text="OK"
                                           FontSize="9"
                                           FontWeight="SemiBold"
                                           Foreground="White" />
                            </Border>
                            <!-- Re-link button -->
                            <Button x:Name="BtnRelink"
                                    Content="Re-link"
                                    Click="BtnRelink_Click"
                                    Visibility="Collapsed"
                                    Margin="8,0,0,0"
                                    Padding="6,2"
                                    FontSize="10"
                                    Background="#374151"
                                    Foreground="#D1D5DB"
                                    BorderThickness="0"
                                    Cursor="Hand" />
                            <!-- Director ID -->
                            <TextBlock Text="    Director ID: "
                                       Foreground="#6B7280"
                                       FontSize="10" />
                            <TextBlock x:Name="HeaderDirectorId"
                                       Foreground="#9CA3AF"
                                       FontSize="10"
                                       FontFamily="Consolas, Courier New" />
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Center top: tabbed terminal + source control -->
                <Grid Grid.Row="1" Background="#1E1E1E">
                <TextBlock x:Name="PlaceholderText"
                           Text="Select or create a session to begin"
                           Foreground="#555555"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           FontSize="16" />

                <TabControl x:Name="SessionTabs"
                            Visibility="Collapsed"
                            Background="#1E1E1E"
                            BorderThickness="0">
                    <TabControl.Resources>
                        <Style TargetType="TabItem">
                            <Setter Property="Background" Value="#2D2D2D" />
                            <Setter Property="Foreground" Value="#888888" />
                            <Setter Property="BorderThickness" Value="0" />
                            <Setter Property="Padding" Value="12,6" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="TabItem">
                                        <Border x:Name="TabBorder"
                                                Background="{TemplateBinding Background}"
                                                Padding="{TemplateBinding Padding}">
                                            <Grid>
                                                <ContentPresenter ContentSource="Header"
                                                                  HorizontalAlignment="Center"
                                                                  VerticalAlignment="Center" />
                                                <Border x:Name="BottomAccent"
                                                        Height="2"
                                                        VerticalAlignment="Bottom"
                                                        Margin="0,0,0,-6"
                                                        Background="Transparent" />
                                            </Grid>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter Property="Background" Value="#1E1E1E" />
                                                <Setter Property="Foreground" Value="#CCCCCC" />
                                                <Setter TargetName="BottomAccent" Property="Background" Value="#007ACC" />
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </TabControl.Resources>

                    <TabItem Header="Terminal">
                        <Grid Background="#1E1E1E">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition x:Name="SummaryColumn" Width="0" />
                            </Grid.ColumnDefinitions>
                            <Border x:Name="TerminalArea" Grid.Column="0" Background="#1E1E1E" />
                            <ScrollBar x:Name="TerminalScrollBar" Grid.Column="1"
                                       Orientation="Vertical"
                                       Visibility="Collapsed"
                                       Style="{StaticResource TerminalScrollBarStyle}"
                                       ValueChanged="TerminalScrollBar_ValueChanged" />

                            <!-- Summary Panel Splitter -->
                            <GridSplitter x:Name="SummarySplitter" Grid.Column="2"
                                          Width="5" Background="#2D2D30"
                                          HorizontalAlignment="Center"
                                          VerticalAlignment="Stretch"
                                          Visibility="Collapsed" />

                            <!-- Session Summary Panel -->
                            <Border x:Name="SummaryPanel" Grid.Column="3"
                                    Background="#1E1E1E" BorderBrush="#3C3C3C"
                                    BorderThickness="1,0,0,0"
                                    Visibility="Collapsed">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" />
                                    </Grid.RowDefinitions>

                                    <!-- Header -->
                                    <Border Grid.Row="0" Background="#252526" Padding="8,6">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="SESSION SUMMARY"
                                                       Foreground="#888888" FontSize="11"
                                                       FontWeight="SemiBold"
                                                       VerticalAlignment="Center" />
                                            <Button x:Name="CloseSummaryButton" Grid.Column="1"
                                                    Content="âœ•" FontSize="10"
                                                    Background="Transparent" Foreground="#888888"
                                                    BorderThickness="0" Padding="4,2"
                                                    Cursor="Hand"
                                                    Click="CloseSummaryButton_Click"
                                                    ToolTip="Hide summary panel" />
                                        </Grid>
                                    </Border>

                                    <!-- Summary Content -->
                                    <Grid Grid.Row="1">
                                        <!-- Empty state message -->
                                        <TextBlock x:Name="SummaryEmptyText"
                                                   Text="No turns yet. Summaries will appear here as you interact with Claude."
                                                   Foreground="#6B7280" FontSize="11"
                                                   FontStyle="Italic"
                                                   TextWrapping="Wrap"
                                                   Margin="12,16"
                                                   VerticalAlignment="Top" />

                                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                                                      HorizontalScrollBarVisibility="Disabled"
                                                      Background="#1E1E1E">
                                            <ItemsControl x:Name="SummaryItemsControl" Padding="8,4">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <StackPanel Margin="0,4,0,8">
                                                            <TextBlock Text="{Binding Header}"
                                                                       Foreground="#569CD6" FontSize="11"
                                                                       FontWeight="SemiBold"
                                                                       Margin="0,0,0,2" />
                                                            <TextBlock Text="{Binding Summary}"
                                                                       Foreground="#CCCCCC" FontSize="12"
                                                                       TextWrapping="Wrap"
                                                                       LineHeight="18" />
                                                        </StackPanel>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Grid>
                                </Grid>
                            </Border>
                        </Grid>
                    </TabItem>
                    <TabItem Header="Source Control">
                        <controls:GitChangesControl x:Name="GitChanges" />
                    </TabItem>
                    <TabItem Header="Repositories">
                        <Grid Margin="12">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Text="Registered Repositories"
                                       Foreground="#CCCCCC" FontWeight="SemiBold"
                                       FontSize="14" Margin="0,0,0,8" />

                            <ListBox x:Name="RepoManagerList" Grid.Row="1"
                                     Background="#1E1E1E"
                                     Foreground="#CCCCCC"
                                     BorderBrush="#3C3C3C"
                                     BorderThickness="1">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="6,4">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Grid.Column="0">
                                                <TextBlock Text="{Binding Name}" FontWeight="Medium" />
                                                <TextBlock Text="{Binding Path}" FontSize="10" Opacity="0.6" />
                                            </StackPanel>
                                            <Border Grid.Column="1"
                                                    Background="#D97706"
                                                    CornerRadius="8"
                                                    Padding="6,2"
                                                    VerticalAlignment="Center"
                                                    Margin="8,0,0,0">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding UncommittedCount}" Value="0">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <TextBlock Text="{Binding UncommittedCount}"
                                                           Foreground="White"
                                                           FontSize="11"
                                                           FontWeight="SemiBold"
                                                           HorizontalAlignment="Center" />
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>

                            <WrapPanel Grid.Row="2" Margin="0,8,0,0" HorizontalAlignment="Left">
                                <Button Content="Clone Repo" Click="BtnCloneRepo_Click"
                                        Height="28" Padding="12,0" Margin="0,0,6,0"
                                        Background="{StaticResource AccentBrush}"
                                        Foreground="White" BorderThickness="0" Cursor="Hand" />
                                <Button Content="Add Existing" Click="BtnAddExistingRepo_Click"
                                        Height="28" Padding="12,0" Margin="0,0,6,0"
                                        Background="{StaticResource ButtonBackground}"
                                        Foreground="{StaticResource TextForeground}" BorderThickness="0" Cursor="Hand" />
                                <Button Content="Create New" Click="BtnCreateRepo_Click"
                                        Height="28" Padding="12,0" Margin="0,0,6,0"
                                        Background="{StaticResource ButtonBackground}"
                                        Foreground="{StaticResource TextForeground}" BorderThickness="0" Cursor="Hand" />
                                <Button Content="Launch Session" Click="BtnLaunchSessionFromRepo_Click"
                                        Height="28" Padding="12,0" Margin="0,0,6,0"
                                        Background="{StaticResource AccentBrush}"
                                        Foreground="White" BorderThickness="0" Cursor="Hand" />
                                <Button Content="Open in Explorer" Click="BtnRepoOpenExplorer_Click"
                                        Height="28" Padding="12,0" Margin="0,0,6,0"
                                        Background="{StaticResource ButtonBackground}"
                                        Foreground="{StaticResource TextForeground}" BorderThickness="0" Cursor="Hand" />
                                <Button Content="Remove" Click="BtnRemoveRepo_Click"
                                        Height="28" Padding="12,0" Margin="0,0,6,0"
                                        Background="{StaticResource ButtonBackground}"
                                        Foreground="{StaticResource TextForeground}" BorderThickness="0" Cursor="Hand" />
                            </WrapPanel>
                        </Grid>
                    </TabItem>
                </TabControl>
                </Grid>

                <!-- Prompt bar (center column only) -->
                <Border x:Name="PromptBar" Grid.Row="2" Background="{StaticResource SidebarBackground}"
                        BorderBrush="#3C3C3C" BorderThickness="0,1,0,0" Padding="8"
                        SizeChanged="PromptArea_SizeChanged"
                        Visibility="Collapsed">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBox x:Name="PromptInput"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 MinLines="3"
                                 MinHeight="65"
                                 MaxHeight="160"
                                 VerticalScrollBarVisibility="Auto"
                                 Background="#1E1E1E"
                                 Foreground="#CCCCCC"
                                 CaretBrush="#CCCCCC"
                                 BorderBrush="#3C3C3C"
                                 BorderThickness="1"
                                 Padding="8,6"
                                 FontFamily="Cascadia Mono, Consolas, Courier New"
                                 FontSize="13"
                                 KeyDown="PromptInput_KeyDown"
                                 GotFocus="PromptInput_GotFocus" />
                        <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Bottom">
                            <Button Content="Send"
                                    Click="BtnSendPrompt_Click"
                                    Width="60" Margin="8,0,0,0"
                                    Height="30"
                                    Background="{StaticResource AccentBrush}"
                                    Foreground="White"
                                    BorderThickness="0"
                                    Cursor="Hand" />
                            <Button Content="&#x21bb;" Click="BtnRefreshConsole_Click"
                                    Width="30" Margin="4,0,0,0"
                                    Height="30"
                                    Background="{StaticResource ButtonBackground}"
                                    Foreground="{StaticResource TextForeground}"
                                    BorderThickness="0"
                                    Cursor="Hand"
                                    ToolTip="Reposition console overlay"
                                    FontSize="16" />
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>

            <!-- Toggle strip for pipe messages -->
            <Border Grid.Column="3" Background="{StaticResource SidebarBackground}" Width="24">
                <Button x:Name="PipeToggleButton" Content="&#x00AB;"
                        Click="TogglePipeMessages_Click"
                        Focusable="False"
                        Background="Transparent" Foreground="#888888"
                        BorderThickness="0" Cursor="Hand"
                        FontSize="14" VerticalAlignment="Center"
                        ToolTip="Toggle pipe messages" />
            </Border>

            <!-- Right sidebar: pipe messages panel (full height, collapsed by default) -->
            <Border x:Name="PipeMessagesPanel" Grid.Column="4" Background="{StaticResource SidebarBackground}" Visibility="Collapsed">
                <DockPanel>
                    <DockPanel DockPanel.Dock="Top" Margin="12,12,12,8">
                        <TextBlock Text="PIPE MESSAGES"
                                   Foreground="{StaticResource TextForeground}"
                                   FontWeight="SemiBold"
                                   FontSize="12"
                                   VerticalAlignment="Center" />
                        <Button x:Name="BtnClearPipeMessages" Content="Clear"
                                Click="BtnClearPipeMessages_Click"
                                HorizontalAlignment="Right"
                                Padding="8,2"
                                Background="{StaticResource ButtonBackground}"
                                Foreground="{StaticResource TextForeground}"
                                BorderThickness="0"
                                Cursor="Hand"
                                FontSize="10" />
                    </DockPanel>

                    <ListBox x:Name="PipeMessageList"
                             Background="Transparent"
                             BorderThickness="0"
                             Foreground="{StaticResource TextForeground}"
                             Margin="4,0"
                             VirtualizingPanel.IsVirtualizing="True"
                             VirtualizingPanel.VirtualizationMode="Recycling"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="2,1">
                                    <DockPanel>
                                        <TextBlock Text="{Binding Timestamp}" FontSize="9"
                                                   Foreground="#888888" Margin="0,0,6,0" />
                                        <TextBlock Text="{Binding EventName}" FontSize="9"
                                                   Foreground="{Binding EventBrush}" FontWeight="SemiBold" />
                                    </DockPanel>
                                    <DockPanel>
                                        <TextBlock Text="{Binding SessionIdShort}" FontSize="9"
                                                   Foreground="#666666" Margin="0,0,6,0" />
                                        <TextBlock Text="{Binding Detail}" FontSize="9"
                                                   Foreground="#AAAAAA" TextTrimming="CharacterEllipsis" />
                                    </DockPanel>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>
    </Grid>
</Window>
