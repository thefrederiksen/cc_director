<Window x:Class="CcDirector.Wpf.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:CcDirector.Wpf.Controls"
        Title="CC Director v2"
        Icon="app.ico"
        Width="1400" Height="700"
        MinWidth="800" MinHeight="500"
        Background="{StaticResource PanelBackground}"
        WindowStartupLocation="CenterScreen">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="264" MinWidth="180" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition x:Name="PipeMessagesColumn" Width="0" />
        </Grid.ColumnDefinitions>

            <!-- Left sidebar: sessions panel (full height) -->
            <Border Grid.Column="0" Background="{StaticResource SidebarBackground}">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top"
                               Text="SESSIONS v2.0-ConPTY"
                               Foreground="{StaticResource TextForeground}"
                               FontWeight="SemiBold"
                               FontSize="12"
                               Margin="12,12,12,8" />

                    <StackPanel DockPanel.Dock="Bottom" Margin="8,4,8,8">
                        <Button x:Name="BtnNewSession" Content="+ New Session"
                                Click="BtnNewSession_Click"
                                Height="30" Margin="0,2"
                                Background="{StaticResource AccentBrush}"
                                Foreground="White"
                                BorderThickness="0"
                                Cursor="Hand" />
                        <Button x:Name="BtnOpenLogs" Content="Open Logs"
                                Click="BtnOpenLogs_Click"
                                Height="30" Margin="0,2"
                                Background="{StaticResource ButtonBackground}"
                                Foreground="{StaticResource TextForeground}"
                                BorderThickness="0"
                                Cursor="Hand"
                                ToolTip="Open log directory in Explorer" />
                    </StackPanel>

                    <ListBox x:Name="SessionList"
                             SelectionChanged="SessionList_SelectionChanged"
                             AllowDrop="True"
                             PreviewMouseMove="SessionList_PreviewMouseMove"
                             PreviewMouseLeftButtonDown="SessionList_PreviewMouseLeftButtonDown"
                             DragOver="SessionList_DragOver"
                             Drop="SessionList_Drop"
                             DragLeave="SessionList_DragLeave"
                             Background="Transparent"
                             BorderThickness="0"
                             Foreground="{StaticResource TextForeground}"
                             Margin="4,0">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="Padding" Value="0" />
                                <Setter Property="Margin" Value="0" />
                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Grid.ContextMenu>
                                        <ContextMenu Opened="SessionContextMenu_Opened" Closed="SessionContextMenu_Closed">
                                            <MenuItem Header="Rename" Click="MenuRenameSession_Click" />
                                            <Separator />
                                            <MenuItem Header="Open in Explorer" Click="MenuOpenInExplorer_Click" />
                                            <MenuItem Header="Open in VS Code" Click="MenuOpenInVsCode_Click" />
                                            <Separator />
                                            <MenuItem Header="Close Session" Click="MenuCloseSession_Click" />
                                        </ContextMenu>
                                    </Grid.ContextMenu>
                                    <Border BorderBrush="{Binding ActivityBrush}"
                                            BorderThickness="4,0,0,0"
                                            Padding="6,2,0,2">
                                        <StackPanel Margin="4,2">
                                            <TextBlock Text="{Binding DisplayName}" FontWeight="Medium"
                                                       TextTrimming="CharacterEllipsis" />
                                            <TextBlock Text="{Binding StatusText}" FontSize="10" Opacity="0.7" />
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>

            <!-- Splitter (left) -->
            <GridSplitter Grid.Column="1" Width="3"
                          Background="{StaticResource PanelBackground}"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Stretch" />

            <!-- Center: header + terminal + prompt stacked vertically -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Session header banner -->
                <Border x:Name="SessionHeaderBanner" Grid.Row="0"
                        Background="#252526"
                        BorderBrush="#3C3C3C" BorderThickness="0,0,0,1"
                        Height="48"
                        Visibility="Collapsed">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <!-- Session name -->
                        <TextBlock x:Name="HeaderSessionName" Grid.Column="0"
                                   Text=""
                                   Foreground="White"
                                   FontSize="20"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"
                                   Margin="16,0,0,0"
                                   TextTrimming="CharacterEllipsis" />

                        <!-- Activity state badge -->
                        <Border x:Name="HeaderStateBadge" Grid.Column="1"
                                CornerRadius="4"
                                Padding="10,4"
                                Margin="0,0,16,0"
                                VerticalAlignment="Center"
                                Background="#336B7280">
                            <TextBlock x:Name="HeaderStateBadgeText"
                                       Text="Starting"
                                       Foreground="White"
                                       FontSize="12"
                                       FontWeight="SemiBold" />
                        </Border>
                    </Grid>
                </Border>

                <!-- Center top: tabbed terminal + source control -->
                <Grid Grid.Row="1" Background="#1E1E1E">
                <TextBlock x:Name="PlaceholderText"
                           Text="Select or create a session to begin"
                           Foreground="#555555"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           FontSize="16" />

                <TabControl x:Name="SessionTabs"
                            Visibility="Collapsed"
                            Background="#1E1E1E"
                            BorderThickness="0">
                    <TabControl.Resources>
                        <Style TargetType="TabItem">
                            <Setter Property="Background" Value="#2D2D2D" />
                            <Setter Property="Foreground" Value="#888888" />
                            <Setter Property="BorderThickness" Value="0" />
                            <Setter Property="Padding" Value="12,6" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="TabItem">
                                        <Border x:Name="TabBorder"
                                                Background="{TemplateBinding Background}"
                                                Padding="{TemplateBinding Padding}">
                                            <Grid>
                                                <ContentPresenter ContentSource="Header"
                                                                  HorizontalAlignment="Center"
                                                                  VerticalAlignment="Center" />
                                                <Border x:Name="BottomAccent"
                                                        Height="2"
                                                        VerticalAlignment="Bottom"
                                                        Margin="0,0,0,-6"
                                                        Background="Transparent" />
                                            </Grid>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter Property="Background" Value="#1E1E1E" />
                                                <Setter Property="Foreground" Value="#CCCCCC" />
                                                <Setter TargetName="BottomAccent" Property="Background" Value="#007ACC" />
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </TabControl.Resources>

                    <TabItem Header="Terminal">
                        <Border x:Name="TerminalArea" Background="#1E1E1E" />
                    </TabItem>
                    <TabItem Header="Source Control">
                        <controls:GitChangesControl x:Name="GitChanges" />
                    </TabItem>
                    <TabItem Header="Repositories">
                        <Grid Margin="12">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Text="Registered Repositories"
                                       Foreground="#CCCCCC" FontWeight="SemiBold"
                                       FontSize="14" Margin="0,0,0,8" />

                            <ListBox x:Name="RepoManagerList" Grid.Row="1"
                                     Background="#1E1E1E"
                                     Foreground="#CCCCCC"
                                     BorderBrush="#3C3C3C"
                                     BorderThickness="1">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="6,4">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Grid.Column="0">
                                                <TextBlock Text="{Binding Name}" FontWeight="Medium" />
                                                <TextBlock Text="{Binding Path}" FontSize="10" Opacity="0.6" />
                                            </StackPanel>
                                            <Border Grid.Column="1"
                                                    Background="#D97706"
                                                    CornerRadius="8"
                                                    Padding="6,2"
                                                    VerticalAlignment="Center"
                                                    Margin="8,0,0,0">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding UncommittedCount}" Value="0">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <TextBlock Text="{Binding UncommittedCount}"
                                                           Foreground="White"
                                                           FontSize="11"
                                                           FontWeight="SemiBold"
                                                           HorizontalAlignment="Center" />
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>

                            <WrapPanel Grid.Row="2" Margin="0,8,0,0" HorizontalAlignment="Left">
                                <Button Content="Clone Repo" Click="BtnCloneRepo_Click"
                                        Height="28" Padding="12,0" Margin="0,0,6,0"
                                        Background="{StaticResource AccentBrush}"
                                        Foreground="White" BorderThickness="0" Cursor="Hand" />
                                <Button Content="Add Existing" Click="BtnAddExistingRepo_Click"
                                        Height="28" Padding="12,0" Margin="0,0,6,0"
                                        Background="{StaticResource ButtonBackground}"
                                        Foreground="{StaticResource TextForeground}" BorderThickness="0" Cursor="Hand" />
                                <Button Content="Create New" Click="BtnCreateRepo_Click"
                                        Height="28" Padding="12,0" Margin="0,0,6,0"
                                        Background="{StaticResource ButtonBackground}"
                                        Foreground="{StaticResource TextForeground}" BorderThickness="0" Cursor="Hand" />
                                <Button Content="Launch Session" Click="BtnLaunchSessionFromRepo_Click"
                                        Height="28" Padding="12,0" Margin="0,0,6,0"
                                        Background="{StaticResource AccentBrush}"
                                        Foreground="White" BorderThickness="0" Cursor="Hand" />
                                <Button Content="Open in Explorer" Click="BtnRepoOpenExplorer_Click"
                                        Height="28" Padding="12,0" Margin="0,0,6,0"
                                        Background="{StaticResource ButtonBackground}"
                                        Foreground="{StaticResource TextForeground}" BorderThickness="0" Cursor="Hand" />
                                <Button Content="Remove" Click="BtnRemoveRepo_Click"
                                        Height="28" Padding="12,0" Margin="0,0,6,0"
                                        Background="{StaticResource ButtonBackground}"
                                        Foreground="{StaticResource TextForeground}" BorderThickness="0" Cursor="Hand" />
                            </WrapPanel>
                        </Grid>
                    </TabItem>
                </TabControl>
                </Grid>

                <!-- Prompt bar (center column only) -->
                <Border Grid.Row="2" Background="{StaticResource SidebarBackground}"
                        BorderBrush="#3C3C3C" BorderThickness="0,1,0,0" Padding="8"
                        SizeChanged="PromptArea_SizeChanged">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBox x:Name="PromptInput"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 MinLines="3"
                                 MinHeight="65"
                                 MaxHeight="160"
                                 VerticalScrollBarVisibility="Auto"
                                 Background="#1E1E1E"
                                 Foreground="#CCCCCC"
                                 CaretBrush="#CCCCCC"
                                 BorderBrush="#3C3C3C"
                                 BorderThickness="1"
                                 Padding="8,6"
                                 FontFamily="Cascadia Mono, Consolas, Courier New"
                                 FontSize="13"
                                 KeyDown="PromptInput_KeyDown"
                                 GotFocus="PromptInput_GotFocus" />
                        <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Bottom">
                            <Button Content="Send"
                                    Click="BtnSendPrompt_Click"
                                    Width="60" Margin="8,0,0,0"
                                    Height="30"
                                    Background="{StaticResource AccentBrush}"
                                    Foreground="White"
                                    BorderThickness="0"
                                    Cursor="Hand" />
                            <Button Content="&#x21bb;" Click="BtnRefreshConsole_Click"
                                    Width="30" Margin="4,0,0,0"
                                    Height="30"
                                    Background="{StaticResource ButtonBackground}"
                                    Foreground="{StaticResource TextForeground}"
                                    BorderThickness="0"
                                    Cursor="Hand"
                                    ToolTip="Reposition console overlay"
                                    FontSize="16" />
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>

            <!-- Toggle strip for pipe messages -->
            <Border Grid.Column="3" Background="{StaticResource SidebarBackground}" Width="24">
                <Button x:Name="PipeToggleButton" Content="&#x00AB;"
                        Click="TogglePipeMessages_Click"
                        Background="Transparent" Foreground="#888888"
                        BorderThickness="0" Cursor="Hand"
                        FontSize="14" VerticalAlignment="Center"
                        ToolTip="Toggle pipe messages" />
            </Border>

            <!-- Right sidebar: pipe messages panel (full height, collapsed by default) -->
            <Border x:Name="PipeMessagesPanel" Grid.Column="4" Background="{StaticResource SidebarBackground}" Visibility="Collapsed">
                <DockPanel>
                    <DockPanel DockPanel.Dock="Top" Margin="12,12,12,8">
                        <TextBlock Text="PIPE MESSAGES"
                                   Foreground="{StaticResource TextForeground}"
                                   FontWeight="SemiBold"
                                   FontSize="12"
                                   VerticalAlignment="Center" />
                        <Button x:Name="BtnClearPipeMessages" Content="Clear"
                                Click="BtnClearPipeMessages_Click"
                                HorizontalAlignment="Right"
                                Padding="8,2"
                                Background="{StaticResource ButtonBackground}"
                                Foreground="{StaticResource TextForeground}"
                                BorderThickness="0"
                                Cursor="Hand"
                                FontSize="10" />
                    </DockPanel>

                    <ListBox x:Name="PipeMessageList"
                             Background="Transparent"
                             BorderThickness="0"
                             Foreground="{StaticResource TextForeground}"
                             Margin="4,0"
                             VirtualizingPanel.IsVirtualizing="True"
                             VirtualizingPanel.VirtualizationMode="Recycling"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="2,1">
                                    <DockPanel>
                                        <TextBlock Text="{Binding Timestamp}" FontSize="9"
                                                   Foreground="#888888" Margin="0,0,6,0" />
                                        <TextBlock Text="{Binding EventName}" FontSize="9"
                                                   Foreground="{Binding EventBrush}" FontWeight="SemiBold" />
                                    </DockPanel>
                                    <DockPanel>
                                        <TextBlock Text="{Binding SessionIdShort}" FontSize="9"
                                                   Foreground="#666666" Margin="0,0,6,0" />
                                        <TextBlock Text="{Binding Detail}" FontSize="9"
                                                   Foreground="#AAAAAA" TextTrimming="CharacterEllipsis" />
                                    </DockPanel>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>
    </Grid>
</Window>
